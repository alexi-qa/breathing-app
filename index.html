<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Breathing exercises with customizable sounds for ADHD and anxiety relief">
    <meta name="theme-color" content="#818cf8">
    <title>ZenBreath - ADHD & Anxiety Relief</title>

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="generated_image_1768594092_0.png">
    <link rel="apple-touch-icon" href="generated_image_1768594092_0.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ZenBreath">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f172a;
            --accent-primary: #818cf8;
            --accent-secondary: #c084fc;
            --accent-green: #10b981;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            background: radial-gradient(circle at top right, #1e1b4b, #0f172a);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            padding-bottom: 80px;
        }

        .app-container {
            width: 100%;
            max-width: 420px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        header { text-align: center; margin-bottom: 8px; padding-top: 10px; }
        h1 {
            font-weight: 300;
            letter-spacing: 4px;
            text-transform: uppercase;
            font-size: 1rem;
            color: var(--text-dim);
        }

        /* Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            z-index: 100;
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: 0.3s;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-btn.active { color: var(--accent-primary); }
        .nav-icon { font-size: 1.2rem; }

        .page { display: none; flex-direction: column; gap: 16px; }
        .page.active { display: flex; }

        /* Visual Guide Section */
        .visual-guide {
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .sphere-container {
            position: relative;
            width: 100px;
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .main-sphere {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 30% 30%, #fff, var(--accent-primary));
            border-radius: 50%;
            box-shadow: 0 0 50px rgba(129, 140, 248, 0.4), inset -10px -10px 20px rgba(0,0,0,0.2);
            transition: transform 0.1s linear;
            z-index: 2;
        }

        .aura-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transition: transform 0.1s linear, opacity 0.5s;
        }

        .status-panel { text-align: center; margin-bottom: 8px; }
        .phase-text {
            font-size: 1.6rem;
            font-weight: 400;
            margin-bottom: 2px;
            background: linear-gradient(to right, #fff, var(--text-dim));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .timer-text {
            font-size: 0.85rem;
            color: var(--text-dim);
            font-variant-numeric: tabular-nums;
        }

        /* Cards */
        .card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 16px;
            backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .section-title {
            font-size: 0.65rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }

        .chip {
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid transparent;
            border-radius: 10px;
            font-size: 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-dim);
        }

        .chip.active {
            background: rgba(129, 140, 248, 0.1);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .num-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 8px;
            color: white;
            text-align: center;
            width: 100%;
            font-size: 0.8rem;
        }

        .slider-row { display: flex; flex-direction: column; gap: 6px; }
        .label-row { display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--text-dim); }

        input[type="range"] {
            width: 100%; height: 4px; background: rgba(255, 255, 255, 0.1);
            border-radius: 2px; appearance: none; outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none; width: 14px; height: 14px; background: white; border-radius: 50%; cursor: pointer;
        }

        .main-actions { display: flex; justify-content: center; gap: 12px; margin-top: 8px; }
        .btn {
            padding: 12px 32px; border-radius: 100px; border: 1px solid var(--glass-border);
            background: var(--glass-bg); color: white; font-size: 0.85rem; cursor: pointer;
            transition: all 0.3s; backdrop-filter: blur(10px); font-weight: 600;
        }
        .btn-primary { background: white; color: var(--bg-dark); border: none; }

        .hidden { display: none; }

        .toggle-group { display: flex; align-items: center; justify-content: space-between; font-size: 0.8rem; }
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(255,255,255,0.1); transition: .4s; border-radius: 20px;
        }
        .slider:before {
            position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent-primary); }
        input:checked + .slider:before { transform: translateX(14px); }

        /* SOUNDS PAGE SPECIFIC STYLES */
        .sound-pill {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 20px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .sound-pill.active {
            background: rgba(16, 185, 129, 0.15);
            border-color: var(--accent-green);
        }

        .sound-icon {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .sound-pill.active .sound-icon {
            background: var(--accent-green);
        }

        .sound-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .sound-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-main);
        }

        .sound-desc {
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        .sound-radio {
            width: 20px;
            height: 20px;
            border: 2px solid var(--text-dim);
            border-radius: 50%;
            position: relative;
            flex-shrink: 0;
            transition: all 0.3s;
        }

        .sound-pill.active .sound-radio {
            border-color: var(--accent-green);
            background: var(--accent-green);
        }

        .sound-pill.active .sound-radio:after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
        }

        .tone-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 100px;
        }

        .tone-card.active {
            background: rgba(16, 185, 129, 0.15);
            border-color: var(--accent-green);
        }

        .tone-icon {
            font-size: 2rem;
        }

        .tone-title {
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
        }

        .tone-subtitle {
            font-size: 0.65rem;
            color: var(--text-dim);
            text-align: center;
        }

        .binaural-pills {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .binaural-pill {
            flex: 1;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            pointer-events: none;
            opacity: 0.5;
        }

        .binaural-pills:not(.hidden) .binaural-pill {
            pointer-events: auto;
            opacity: 1;
        }

        .binaural-pill.active {
            background: rgba(129, 140, 248, 0.15);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .binaural-pill-icon {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 4px;
        }

        .binaural-pill-title {
            font-size: 0.75rem;
            font-weight: 600;
            display: block;
        }

        .binaural-pill-freq {
            font-size: 0.6rem;
            color: var(--text-dim);
            display: block;
            margin-top: 2px;
        }

        /* Install prompt */
        .install-prompt {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-primary);
            color: white;
            padding: 12px 24px;
            border-radius: 100px;
            display: none;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 20px rgba(129, 140, 248, 0.4);
            z-index: 1000;
            animation: slideUp 0.3s ease;
        }

        .install-prompt.show {
            display: flex;
        }

        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .install-btn {
            background: white;
            color: var(--accent-primary);
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .close-prompt {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            width: 24px;
            height: 24px;
        }
    </style>
</head>
<body>
    <!-- Install Prompt -->
    <div class="install-prompt" id="installPrompt">
        <span>üì± Install ZenBreath for offline use</span>
        <button class="install-btn" id="installBtn">Install</button>
        <button class="close-prompt" id="closePrompt">√ó</button>
    </div>

    <div class="app-container">
        <!-- BREATHE PAGE -->
        <div class="page active" id="breathePage">
            <header><h1>ZenBreath</h1></header>
            <div class="visual-guide">
                <div class="sphere-container">
                    <div class="aura-ring" id="ring1"></div>
                    <div class="aura-ring" id="ring2" style="transform: scale(1.2); opacity: 0.5;"></div>
                    <div class="main-sphere" id="sphere"></div>
                </div>
            </div>
            <div class="status-panel">
                <div class="phase-text" id="phaseText">Ready</div>
                <div class="timer-text" id="timerText">Tap start to begin</div>
            </div>
            <div class="main-actions">
                <button class="btn btn-primary" id="startBtn">START</button>
                <button class="btn" id="stopBtn">STOP</button>
            </div>
            <div class="card">
                <div class="section-title">Breathing Pattern</div>
                <div class="grid-3">
                    <div class="chip active" onclick="setPreset('box', this)">Box</div>
                    <div class="chip" onclick="setPreset('relax', this)">Relax</div>
                    <div class="chip" onclick="setPreset('focus', this)">Focus</div>
                </div>
                <div class="grid-4">
                    <div class="slider-row"><div class="label-row">In</div><input type="number" class="num-input" id="in" value="4"></div>
                    <div class="slider-row"><div class="label-row">H1</div><input type="number" class="num-input" id="h1" value="4"></div>
                    <div class="slider-row"><div class="label-row">Out</div><input type="number" class="num-input" id="out" value="4"></div>
                    <div class="slider-row"><div class="label-row">H2</div><input type="number" class="num-input" id="h2" value="4"></div>
                </div>
            </div>
            <div class="card">
                <div class="section-title">Sound Engine</div>
                <div class="grid-3">
                    <div class="chip active" onclick="setMode('pink', this)">Pink</div>
                    <div class="chip" onclick="setMode('brown', this)">Brown</div>
                    <div class="chip" onclick="setMode('white', this)">White</div>
                    <div class="chip" onclick="setMode('clicks', this)">Clicks</div>
                    <div class="chip" onclick="setMode('solfeggio', this)">528Hz</div>
                    <div class="chip" onclick="setMode('ocean', this)">Ocean</div>
                </div>
                <div class="slider-row" id="softnessRow">
                    <div class="label-row"><span>Softness</span><span id="softVal">50%</span></div>
                    <input type="range" id="softness" min="0" max="100" value="50">
                </div>
                <div class="slider-row hidden" id="clickSpeedRow">
                    <div class="label-row"><span>Click Speed</span><span id="speedVal">1.0x</span></div>
                    <input type="range" id="clickSpeed" min="5" max="100" value="10" step="5">
                </div>
                <div class="slider-row">
                    <div class="label-row"><span>Volume</span><span id="volVal">30%</span></div>
                    <input type="range" id="volume" min="0" max="100" value="30">
                </div>
            </div>
            <div class="card">
                <div class="toggle-group">
                    <span>8D Spatial Audio</span>
                    <label class="switch">
                        <input type="checkbox" id="spatialToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="toggle-group" style="margin-top: 8px;">
                    <span>Binaural Beats</span>
                    <label class="switch">
                        <input type="checkbox" id="binauralToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- SOUNDS PAGE -->
        <div class="page" id="soundsPage">
            <header><h1>Soundscape</h1></header>

            <!-- Master Volume -->
            <div class="card">
                <div class="slider-row">
                    <div class="label-row"><span>üîä MASTER VOLUME</span><span id="masterVolVal">22%</span></div>
                    <input type="range" id="masterVolume" min="0" max="100" value="22">
                </div>
            </div>

            <!-- Noise Colors -->
            <div class="card">
                <div class="section-title">NOISE COLORS</div>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div class="sound-pill active" onclick="selectSound('pink', this)">
                        <div class="sound-icon">üå∏</div>
                        <div class="sound-info">
                            <div class="sound-title">Pink Noise</div>
                            <div class="sound-desc">Balanced, natural sound for focus</div>
                        </div>
                        <div class="sound-radio"></div>
                    </div>
                    <div class="sound-pill" onclick="selectSound('brown', this)">
                        <div class="sound-icon">„Ä∞Ô∏è</div>
                        <div class="sound-info">
                            <div class="sound-title">Brown Noise</div>
                            <div class="sound-desc">Deep, rumbling sound for relaxation</div>
                        </div>
                        <div class="sound-radio"></div>
                    </div>
                    <div class="sound-pill" onclick="selectSound('white', this)">
                        <div class="sound-icon">‚ö™</div>
                        <div class="sound-info">
                            <div class="sound-title">White Noise</div>
                            <div class="sound-desc">Constant intensity for masking</div>
                        </div>
                        <div class="sound-radio"></div>
                    </div>
                </div>
            </div>

            <!-- Atmospheric & Tones -->
            <div class="card">
                <div class="section-title">ATMOSPHERIC & TONES</div>
                <div class="grid-2">
                    <div class="tone-card" onclick="selectTone('ocean', this)">
                        <div class="tone-icon">üåä</div>
                        <div class="tone-title">Ocean</div>
                        <div class="tone-subtitle">Rhythmic Waves</div>
                    </div>
                    <div class="tone-card" onclick="selectTone('solfeggio', this)">
                        <div class="tone-icon">‚ö°</div>
                        <div class="tone-title">Solfeggio</div>
                        <div class="tone-subtitle">528Hz Healing</div>
                    </div>
                    <div class="tone-card" onclick="selectTone('432hz', this)">
                        <div class="tone-icon">‚ö°</div>
                        <div class="tone-title">432Hz Tone</div>
                        <div class="tone-subtitle">Deep Relaxation</div>
                    </div>
                    <div class="tone-card" onclick="selectTone('440hz', this)">
                        <div class="tone-icon">‚ö°</div>
                        <div class="tone-title">440Hz Tone</div>
                        <div class="tone-subtitle">Pure Clarity</div>
                    </div>
                </div>
            </div>

            <!-- Binaural Beats -->
            <div class="card">
                <div class="section-title">BINAURAL BEATS</div>
                <div class="toggle-group">
                    <span style="font-size: 0.8rem;">Enable Binaural</span>
                    <label class="switch">
                        <input type="checkbox" id="binauralToggleSounds" onchange="toggleBinauralOptions()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="binaural-pills hidden" id="binauralOptions">
                    <div class="binaural-pill" onclick="selectBinaural('theta', this)">
                        <span class="binaural-pill-icon">üßò</span>
                        <span class="binaural-pill-title">Theta</span>
                        <span class="binaural-pill-freq">4Hz ‚Äì Deep</span>
                    </div>
                    <div class="binaural-pill active" onclick="selectBinaural('alpha', this)">
                        <span class="binaural-pill-icon">üßò</span>
                        <span class="binaural-pill-title">Alpha</span>
                        <span class="binaural-pill-freq">10Hz ‚Äì Relax</span>
                    </div>
                    <div class="binaural-pill" onclick="selectBinaural('gamma', this)">
                        <span class="binaural-pill-icon">üßò</span>
                        <span class="binaural-pill-title">Gamma</span>
                        <span class="binaural-pill-freq">40Hz ‚Äì Focus</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="switchPage('breathePage', this)">
            <span class="nav-icon">ü´Å</span>
            <span>Breathe</span>
        </button>
        <button class="nav-btn" onclick="switchPage('soundsPage', this)">
            <span class="nav-icon">üéµ</span>
            <span>Sounds</span>
        </button>
    </nav>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let isRunning = false;
        let currentMode = 'pink';
        let currentSound = 'pink';
        let binauralFreq = 10;
        let binauralEnabled = false;

        const masterGain = audioCtx.createGain();
        masterGain.connect(audioCtx.destination);
        masterGain.gain.value = 0.22;

        const noiseGain = audioCtx.createGain();
        noiseGain.connect(masterGain);
        noiseGain.gain.value = 0;

        const filter = audioCtx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.value = 1000;

        const toneGain = audioCtx.createGain();
        toneGain.connect(masterGain);
        toneGain.gain.value = 0;

        let noiseSource = null;
        let binauralNodes = null;
        let phaseTimer;
        let currentToneOsc = null;

        // PWA Install Logic
        let deferredPrompt;
        const installPrompt = document.getElementById('installPrompt');
        const installBtn = document.getElementById('installBtn');
        const closePrompt = document.getElementById('closePrompt');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installPrompt.classList.add('show');
        });

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response: ${outcome}`);
                deferredPrompt = null;
                installPrompt.classList.remove('show');
            }
        });

        closePrompt.addEventListener('click', () => {
            installPrompt.classList.remove('show');
        });

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }

        function switchPage(pageId, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }

        function createNoise(type) {
            const bufferSize = audioCtx.sampleRate * 2;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            if (type === 'pink') {
                let b0=0, b1=0, b2=0, b3=0, b4=0, b5=0, b6=0;
                for (let i=0; i<bufferSize; i++) {
                    const white = Math.random() * 2 - 1;
                    b0 = 0.99886 * b0 + white * 0.0555179;
                    b1 = 0.99332 * b1 + white * 0.0750759;
                    b2 = 0.96900 * b2 + white * 0.1538520;
                    b3 = 0.86650 * b3 + white * 0.3104856;
                    b4 = 0.55000 * b4 + white * 0.5329522;
                    b5 = -0.7616 * b5 - white * 0.0168980;
                    data[i] = (b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362) * 0.11;
                    b6 = white * 0.115926;
                }
            } else if (type === 'brown') {
                let lastOut = 0;
                for (let i=0; i<bufferSize; i++) {
                    const white = Math.random() * 2 - 1;
                    data[i] = (lastOut + (0.02 * white)) / 1.02;
                    lastOut = data[i];
                    data[i] *= 3.5;
                }
            } else {
                for (let i=0; i<bufferSize; i++) data[i] = Math.random() * 2 - 1;
            }
            if (noiseSource) noiseSource.stop();
            noiseSource = audioCtx.createBufferSource();
            noiseSource.buffer = buffer;
            noiseSource.loop = true;
            noiseSource.connect(filter).connect(noiseGain);
            noiseSource.start();
        }

        function startBinaural() {
            stopBinaural();
            const oscL = audioCtx.createOscillator();
            const oscR = audioCtx.createOscillator();
            const gL = audioCtx.createGain();
            const gR = audioCtx.createGain();
            const merger = audioCtx.createChannelMerger(2);
            oscL.frequency.value = 200;
            oscR.frequency.value = 200 + binauralFreq;
            gL.gain.value = gR.gain.value = 0.05;
            oscL.connect(gL).connect(merger, 0, 0);
            oscR.connect(gR).connect(merger, 0, 1);
            merger.connect(masterGain);
            oscL.start(); oscR.start();
            binauralNodes = { oscL, oscR };
        }

        function stopBinaural() {
            if (binauralNodes) {
                binauralNodes.oscL.stop(); binauralNodes.oscR.stop();
                binauralNodes = null;
            }
        }

        function stopAllSounds() {
            const now = audioCtx.currentTime;
            noiseGain.gain.setTargetAtTime(0, now, 0.1);
            toneGain.gain.setTargetAtTime(0, now, 0.1);
            if (currentToneOsc) { 
                setTimeout(() => {
                    if (currentToneOsc) currentToneOsc.stop(); 
                    currentToneOsc = null; 
                }, 200);
            }
        }

        // Breathe Page Handlers
        function setPreset(type, el) {
            document.querySelectorAll('#breathePage .chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            const vals = { box: [4,4,4,4], relax: [4,7,8,0], focus: [3,0,3,0] }[type];
            ['in','h1','out','h2'].forEach((id, i) => document.getElementById(id).value = vals[i]);
        }

        function setMode(mode, el) {
            currentMode = mode;
            document.querySelectorAll('#breathePage .chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('softnessRow').classList.toggle('hidden', mode === 'clicks' || mode === 'solfeggio' || mode === 'ocean');
            document.getElementById('clickSpeedRow').classList.toggle('hidden', mode !== 'clicks');
        }

        // Sounds Page Handlers
        function selectSound(sound, el) {
            if (el.classList.contains('active')) {
                el.classList.remove('active');
                currentSound = null;
                stopAllSounds();
                return;
            }

            document.querySelectorAll('.tone-card').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.sound-pill').forEach(p => p.classList.remove('active'));
            el.classList.add('active');
            currentSound = sound;
            playStandaloneSound();
        }

        function selectTone(tone, el) {
            if (el.classList.contains('active')) {
                el.classList.remove('active');
                currentSound = null;
                stopAllSounds();
                return;
            }

            document.querySelectorAll('.sound-pill').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tone-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            currentSound = tone;
            playStandaloneSound();
        }

        function selectBinaural(type, el) {
            if (el.classList.contains('active')) {
                el.classList.remove('active');
                binauralFreq = null;
                stopBinaural();
                return;
            }

            document.querySelectorAll('.binaural-pill').forEach(p => p.classList.remove('active'));
            el.classList.add('active');
            binauralFreq = { theta: 6, alpha: 10, gamma: 40 }[type];
            if (binauralEnabled) startBinaural();
        }

        function toggleBinauralOptions() {
            binauralEnabled = document.getElementById('binauralToggleSounds').checked;
            document.getElementById('binauralOptions').classList.toggle('hidden', !binauralEnabled);
            if (binauralEnabled) {
                if (binauralFreq) startBinaural();
            } else {
                stopBinaural();
            }
        }

        function playStandaloneSound() {
            if (!currentSound) {
                stopAllSounds();
                return;
            }

            audioCtx.resume();
            const now = audioCtx.currentTime;
            noiseGain.gain.setTargetAtTime(0, now, 0.1);
            toneGain.gain.setTargetAtTime(0, now, 0.1);
            if (currentToneOsc) { currentToneOsc.stop(); currentToneOsc = null; }

            if (['pink','brown','white','ocean'].includes(currentSound)) {
                createNoise(currentSound === 'ocean' ? 'pink' : currentSound);
                noiseGain.gain.setTargetAtTime(0.3, now, 0.5);
                filter.frequency.value = currentSound === 'ocean' ? 800 : 2000;
            } else {
                const freq = { solfeggio: 528, '432hz': 432, '440hz': 440 }[currentSound];
                currentToneOsc = audioCtx.createOscillator();
                currentToneOsc.frequency.value = freq;
                currentToneOsc.connect(toneGain);
                toneGain.gain.setTargetAtTime(0.1, now, 0.5);
                currentToneOsc.start();
            }
        }

        // Breathe Logic
        function startBreathe() {
            if (isRunning) return;
            isRunning = true;
            audioCtx.resume();
            if (document.getElementById('binauralToggle').checked) startBinaural();
            createNoise(currentMode === 'clicks' || currentMode === 'solfeggio' ? 'pink' : currentMode);
            runCycle();
        }

        function stopBreathe() {
            isRunning = false;
            clearTimeout(phaseTimer);
            noiseGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.2);
            toneGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.2);
            stopBinaural();
            document.getElementById('phaseText').textContent = "Ready";
            document.getElementById('sphere').style.transform = "scale(1)";
        }

        function runCycle() {
            if (!isRunning) return;
            const pattern = ['in','h1','out','h2'].map(id => parseInt(document.getElementById(id).value));
            const phases = [
                { name: 'Breathe In', dur: pattern[0], scale: 1.8 },
                { name: 'Hold', dur: pattern[1], scale: 1.8 },
                { name: 'Breathe Out', dur: pattern[2], scale: 1.0 },
                { name: 'Hold', dur: pattern[3], scale: 1.0 }
            ].filter(p => p.dur > 0);
            let idx = 0;
            const next = () => {
                if (!isRunning) return;
                const p = phases[idx];
                document.getElementById('phaseText').textContent = p.name;
                document.getElementById('sphere').style.transition = `transform ${p.dur}s linear`;
                document.getElementById('sphere').style.transform = `scale(${p.scale})`;
                handleBreatheAudio(p.name, p.dur);
                phaseTimer = setTimeout(() => {
                    idx = (idx + 1) % phases.length;
                    next();
                }, p.dur * 1000);
            };
            next();
        }

        function handleBreatheAudio(phase, dur) {
            const now = audioCtx.currentTime;
            if (phase === 'Hold') {
                noiseGain.gain.setTargetAtTime(0.05, now, 0.5);
                toneGain.gain.setTargetAtTime(0, now, 0.5);
                return;
            }
            if (currentMode === 'clicks') {
                const count = Math.floor(dur * (document.getElementById('clickSpeed').value / 10));
                for(let i=0; i<count; i++) {
                    setTimeout(() => {
                        if (!isRunning) return;
                        const osc = audioCtx.createOscillator();
                        const g = audioCtx.createGain();
                        osc.frequency.value = phase === 'Breathe In' ? 400 + (i/count)*400 : 800 - (i/count)*400;
                        g.gain.value = 0.1;
                        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
                        osc.connect(g).connect(masterGain);
                        osc.start(); osc.stop(audioCtx.currentTime + 0.05);
                    }, (i * (dur/count)) * 1000);
                }
            } else if (currentMode === 'solfeggio') {
                const osc = audioCtx.createOscillator();
                osc.frequency.value = 528;
                toneGain.gain.cancelScheduledValues(now);
                toneGain.gain.setValueAtTime(0, now);
                toneGain.gain.linearRampToValueAtTime(0.1, now + 0.5);
                toneGain.gain.linearRampToValueAtTime(0, now + dur);
                osc.connect(toneGain);
                osc.start(); osc.stop(now + dur);
            } else {
                noiseGain.gain.setTargetAtTime(0.3, now, 0.5);
                filter.frequency.setTargetAtTime(phase === 'Breathe In' ? 2000 : 400, now, 0.5);
            }
        }

        // Event Listeners
        document.getElementById('startBtn').onclick = startBreathe;
        document.getElementById('stopBtn').onclick = stopBreathe;
        document.getElementById('masterVolume').oninput = (e) => {
            masterGain.gain.value = e.target.value / 100;
            document.getElementById('masterVolVal').textContent = e.target.value + '%';
        };
        document.getElementById('volume').oninput = (e) => {
            masterGain.gain.value = e.target.value / 100;
            document.getElementById('volVal').textContent = e.target.value + '%';
        };
        document.getElementById('softness').oninput = (e) => {
            filter.frequency.value = 200 + (e.target.value/100)*3800;
            document.getElementById('softVal').textContent = e.target.value + '%';
        };
        document.getElementById('clickSpeed').oninput = (e) => {
            document.getElementById('speedVal').textContent = (e.target.value/10).toFixed(1) + 'x';
        };
        document.getElementById('binauralToggle').onchange = (e) => {
            if (e.target.checked) startBinaural();
            else stopBinaural();
        };

        // Auto-play first sound on Sounds page
        setTimeout(() => playStandaloneSound(), 100);
    </script>
</body>
</html>